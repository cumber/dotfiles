#!/usr/bin/env bash

set -e

GHC_VERSION="$(ghc --version | sed -ne 's/^.*version \([0-9]\+\.[0-9]\+\.[0-9]\+\).*$/\1/p')"
GHC_TAG="x86_64-linux-ghc-${GHC_VERSION}"
HOOGLE_VERSION="$(hoogle --version | sed -ne 's/Hoogle v\([0-9]\+\.[0-9]\+\.[0-9]\+\).*$/\1/p')"

CABAL_SHARE="${HOME}/.cabal/share"
HOOGLE_DATABASES="${CABAL_SHARE}/${GHC_TAG}/hoogle-${HOOGLE_VERSION}/databases"


for f in "${CABAL_SHARE}/doc/${GHC_TAG}"/*/html/*.txt; do
    ${DRYRUN} hoogle convert "$f" "${HOOGLE_DATABASES}/$(basename "${f%.txt}.hoo")"
done

${DRYRUN} hoogle combine "${HOOGLE_DATABASES}"/*.hoo "${HOOGLE_DATABASES}/default.hoo"
